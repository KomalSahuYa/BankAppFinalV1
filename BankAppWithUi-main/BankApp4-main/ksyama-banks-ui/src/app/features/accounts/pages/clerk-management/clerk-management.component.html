<div *ngIf="permissionService.canViewAllUsers(); else noUserAccess" class="container-fluid py-3">
  <app-status-message type="danger" [message]="errorMessage"></app-status-message>

  <div class="mb-3 d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Clerk Management</h4>
    <button class="btn btn-primary" (click)="openCreateForm()">Create Clerk</button>
  </div>

  <div class="card p-4 app-card mb-3" *ngIf="showCreateForm">
    <h5>Create Clerk</h5>
    <form [formGroup]="form" (ngSubmit)="createClerk()" class="row g-3" novalidate>
      <div class="col-md-6"><input class="form-control" placeholder="Username" formControlName="username" /></div>
      <div class="col-md-6"><input class="form-control" type="password" placeholder="Password" formControlName="password" /></div>
      <div class="col-md-6"><input class="form-control" placeholder="Full name" formControlName="fullName" /></div>
      <div class="col-md-6"><input class="form-control" placeholder="Email" formControlName="emailId" /></div>
      <div class="col-md-6"><input class="form-control" placeholder="Phone Number" formControlName="phoneNumber" maxlength="10" /></div>
      <div class="col-md-6"><input class="form-control" placeholder="Aadhaar Number" formControlName="aadhaarNumber" maxlength="12" /></div>
      <div class="col-12 d-flex gap-2 justify-content-end">
        <button class="btn btn-outline-secondary" type="button" (click)="showCreateForm=false">Cancel</button>
        <button class="btn btn-primary" [disabled]="isSubmitting || form.invalid" type="submit">Review Details</button>
      </div>
    </form>
  </div>

  <div class="card p-4 app-card mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="mb-0">Clerk Directory</h4>
      <button class="btn btn-outline-secondary btn-sm" [disabled]="loading" (click)="loadEmployees()">Refresh</button>
    </div>
    <div *ngIf="loading">Loading employees...</div>
    <table class="table align-middle clerk-table" *ngIf="!loading">
      <tr><th>ID</th><th>Username</th><th>Name</th><th>Email</th><th>Phone</th><th>Aadhaar</th><th>Actions</th></tr>
      <tr *ngFor="let emp of clerks">
        <td>{{ emp.id }}</td>
        <td>{{ emp.username }}</td>
        <td>
          <ng-container *ngIf="editingEmployeeId !== emp.id; else editName">{{ emp.fullName }}</ng-container>
          <ng-template #editName><input class="form-control form-control-sm" [formControl]="editForm.controls.fullName" readonly /></ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingEmployeeId !== emp.id; else editEmail">{{ emp.emailId }}</ng-container>
          <ng-template #editEmail><input class="form-control form-control-sm" [formControl]="editForm.controls.emailId" /></ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingEmployeeId !== emp.id; else editPhone">{{ emp.phoneNumber }}</ng-container>
          <ng-template #editPhone><input class="form-control form-control-sm" [formControl]="editForm.controls.phoneNumber" /></ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingEmployeeId !== emp.id; else editAadhaar">{{ emp.aadhaarNumber }}</ng-container>
          <ng-template #editAadhaar><input class="form-control form-control-sm" [formControl]="editForm.controls.aadhaarNumber" readonly /></ng-template>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1" *ngIf="editingEmployeeId !== emp.id" (click)="startEdit(emp)">Edit</button>
          <button class="btn btn-sm btn-primary me-1" *ngIf="editingEmployeeId === emp.id" (click)="updateEmployee(emp)">Save</button>
          <button class="btn btn-sm btn-outline-secondary me-1" *ngIf="editingEmployeeId === emp.id" (click)="cancelEdit()">Cancel</button>
          <button class="btn btn-sm btn-outline-danger" [disabled]="actionInProgress" (click)="askDeleteEmployee(emp)">Delete</button>
        </td>
      </tr>
    </table>
  </div>
</div>

<div class="dialog-backdrop" *ngIf="showCreateConfirm">
  <div class="dialog-card">
    <h5 class="mb-2">Confirm Clerk Details</h5>
    <p><strong>Name:</strong> {{ form.controls.fullName.value }}</p>
    <p><strong>Username:</strong> {{ form.controls.username.value }}</p>
    <p><strong>Email:</strong> {{ form.controls.emailId.value }}</p>
    <p><strong>Phone:</strong> {{ form.controls.phoneNumber.value }}</p>
    <p><strong>Aadhaar:</strong> {{ form.controls.aadhaarNumber.value }}</p>
    <p class="text-warning small">Second confirmation: Are you sure you want to create this clerk?</p>
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-secondary" type="button" (click)="closeCreateConfirm()">Back</button>
      <button class="btn btn-primary" type="button" [disabled]="isSubmitting" (click)="confirmCreateClerk()">Confirm & Create</button>
    </div>
  </div>
</div>

<div class="dialog-backdrop" *ngIf="employeeToDelete">
  <div class="dialog-card">
    <h5 class="mb-2">Delete clerk user</h5>
    <p class="mb-3">Are you sure you want to delete <strong>{{ employeeToDelete?.username }}</strong>?</p>
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-outline-secondary" type="button" (click)="cancelDelete()">Cancel</button>
      <button class="btn btn-danger" type="button" [disabled]="actionInProgress" (click)="confirmDeleteEmployee()">Delete</button>
    </div>
  </div>
</div>

<ng-template #noUserAccess><p class="text-danger">You are not authorized to manage users.</p></ng-template>
